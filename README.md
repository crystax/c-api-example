# C++ API example

This is an example how to implement C++ API for some library, keeping it backward compatible on binary level.

Of course, it will work only if compiler don't break ABI (Application Binary Interface) of generated binary code between its versions; otherwise, compatibility will be broken, no matter what language would be used for API implementation.

Branch 'master' demonstrate the easiest approach, which works when dynamic linker support lazy resolving of external symbols. This approach works fine in modern OS, such as OS X and GNU/Linux. It doesn't work on Android due to Android's dynamic linker limitations.

Branch 'generic' demonstrate bit more complicate approach, where API developer implement lazy resolving of external symbols on his own, not relying on dynamic linker capabilities. This approach works fine on any POSIX-compatible OS, where dlopen/dlsym available (including Android).

To run it on OS X or GNU/Linux, just cd to the top directory and run `make`:

    $ make
    ......
    === Run with libv1:
    DYLD_LIBRARY_PATH=bin/darwin/:bin/darwin/libv1/ ./bin/darwin/app
    We're running on system v1
    my location: 1.1/2.2
    md altitude: 1.3
    === Run with libv2:
    DYLD_LIBRARY_PATH=bin/darwin/:bin/darwin/libv2/ ./bin/darwin/app
    We're running on system v2
    my location: 1.1/2.2/3.3
    map location: 1.1/2.2/3.3
    md altitude: Method md::location_altitude() is deprecated! Use geo::altitude() instead!

For Android build, [CrystaX NDK](https://www.crystax.net/android/ndk) needed. To build and run example on device, cd to the top directory and type `make NDK=/path/to/the/crystax-ndk` (**WARNING!!!** Works only in "generic" branch due to limitations of Android's dynamic linker!):

    $ git checkout generic
    ......
    $ make NDK=/opt/android/crystax-ndk-10.2.0
    ......
    === Deploy binaries to device
    adb shell 'test -e /data/local/tmp/cxxapi && rm -r /data/local/tmp/cxxapi'
    adb shell 'mkdir -p /data/local/tmp/cxxapi'
    adb shell 'mkdir -p /data/local/tmp/cxxapi/libv1'
    adb shell 'mkdir -p /data/local/tmp/cxxapi/libv2'
    adb push /opt/android/crystax-ndk-10.2.0/sources/crystax/libs/armeabi-v7a/libcrystax.so /data/local/tmp/cxxapi/
    4349 KB/s (3296588 bytes in 0.740s)
    adb push /opt/android/crystax-ndk-10.2.0/sources/cxx-stl/gnu-libstdc++/4.9/libs/armeabi/libgnustl_shared.so /data/local/tmp/cxxapi/
    3556 KB/s (5930856 bytes in 1.628s)
    adb push bin/android/libv1/libv.so /data/local/tmp/cxxapi/libv1/
    3973 KB/s (69460 bytes in 0.017s)
    adb push bin/android/libv2/libv.so /data/local/tmp/cxxapi/libv2/
    4236 KB/s (72188 bytes in 0.016s)
    adb push bin/android/libapp.so /data/local/tmp/cxxapi/
    3477 KB/s (68496 bytes in 0.019s)
    adb push bin/android/app /data/local/tmp/cxxapi/
    1510 KB/s (7056 bytes in 0.004s)
    adb shell 'chmod 0700 /data/local/tmp/cxxapi/app'
    === Run with libv1:
    adb shell 'cd /data/local/tmp/cxxapi && LD_LIBRARY_PATH=/data/local/tmp/cxxapi:/data/local/tmp/cxxapi/libv1 ./app'
    We're running on system v1
    my location: 1.1/2.2
    md altitude: 1.3
    === Run with libv2:
    adb shell 'cd /data/local/tmp/cxxapi && LD_LIBRARY_PATH=/data/local/tmp/cxxapi:/data/local/tmp/cxxapi/libv2 ./app'
    We're running on system v2
    my location: 1.1/2.2/3.3
    map location: 1.1/2.2/3.3
    md altitude: Method md::location_altitude() is deprecated! Use geo::altitude() instead!

In both cases ("master" and "generic" branch) external C++ API is the same, and for API user looks and behaves absolutely identical. Second ("generic") approach is bit more difficult to the API developer, but not so much, because significant amount of C <-> C++ adapters could be auto-generated by the script.

This is just an example, demonstrating idea. To make it production-ready, numerous modifications needed; don't use it in production "as is"!
